---
import WikiCard from "./WikiCard.astro";

type PageLike = {
  id: string;
  data: { title: string; description?: string; tags?: string[] };
};

const {
  basePath,     // 例: `${BASE}/phasmophobia/`
  pages,
} = Astro.props as {
  basePath: string;
  pages: PageLike[];
};

// タグ頻度
const tagCount = new Map<string, number>();
for (const p of pages) for (const t of p.data.tags ?? []) tagCount.set(t, (tagCount.get(t) ?? 0) + 1);
const tags = [...tagCount.entries()].sort((a, b) => b[1] - a[1]).map(([t]) => t);
---

<div class="controls">
  <label class="search">
    <span class="sr-only">検索</span>
    <input id="q" type="search" placeholder="検索" autocomplete="off" />
  </label>

  <div class="tagbar" id="tags">
    <button class="t ghost" type="button" data-tag="">全て</button>
    {tags.map((t) => (
      <button class="t" type="button" data-tag={t}>
        #{t} <span class="n">{tagCount.get(t)}</span>
      </button>
    ))}
  </div>
</div>

<ul class="grid" id="grid">
  {pages.map((p) => (
    <WikiCard
      href={`${basePath}${p.id}/`}
      title={p.data.title}
      description={p.data.description}
      tags={p.data.tags ?? []}
    />
  ))}
</ul>

<div class="empty" id="empty" hidden>
  <div class="emptyTitle">該当ページがありません</div>
  <div class="muted">検索語やタグを変えてください。</div>
</div>

<script>
  const q = document.getElementById("q");
  const tags = document.getElementById("tags");
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");

  let activeTag = "";

  function apply() {
    const query = (q.value || "").trim().toLowerCase();
    const nodes = [...grid.querySelectorAll("li.card")];

    let shown = 0;
    for (const el of nodes) {
      const title = (el.dataset.title || "");
      const tagStr = (el.dataset.tags || "");

      const okQuery = !query || title.includes(query) || tagStr.includes(query);
      const okTag = !activeTag || tagStr.includes(activeTag);

      const ok = okQuery && okTag;
      el.hidden = !ok;
      if (ok) shown++;
    }
    empty.hidden = shown !== 0;
  }

  q.addEventListener("input", apply);
  tags.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-tag]");
    if (!btn) return;
    activeTag = (btn.dataset.tag || "").toLowerCase();

    for (const b of tags.querySelectorAll("button[data-tag]")) {
      const isActive = (b.dataset.tag || "").toLowerCase() === activeTag && activeTag !== "";
      b.classList.toggle("active", isActive);
    }
    apply();
  });

  apply();
</script>

<style>
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .muted{color: var(--muted);}

  .controls{display:grid;gap:12px;margin-bottom:14px}
  .search input{
    width:min(560px, 100%);
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--stroke);
    background: var(--panel2);
    outline:none;
  }
  .search input:focus{border-color: rgba(109,40,217,.45); background:#fff}

  .tagbar{display:flex;flex-wrap:wrap;gap:8px}
  .t{
    cursor:pointer;
    border:1px solid var(--stroke);
    background: var(--panel2);
    color: rgba(11,18,32,.82);
    padding:7px 10px;
    border-radius:999px;
    font-size:.88rem;
  }
  .t:hover{border-color: rgba(109,40,217,.35); background: rgba(109,40,217,.06)}
  .t.active{border-color: rgba(109,40,217,.55); background: rgba(109,40,217,.10)}
  .t .n{opacity:.65; margin-left:6px}
  .t.ghost{opacity:.9}

  .grid{
    list-style:none;
    padding:0;
    margin:0;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:12px;
  }
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .empty{
    margin-top:14px;
    padding:18px;
    border-radius: var(--r);
    border:1px dashed var(--stroke);
    background: var(--panel2);
    text-align:center;
  }
  .emptyTitle{font-weight:800;margin-bottom:4px}
</style>
