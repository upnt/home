---
import { getCollection } from "astro:content";
import WikiLayout from "../../layouts/WikiLayout.astro";

const BASE = import.meta.env.BASE_URL.replace(/\/+$/, "");
const entries = await getCollection("phasmoWiki", ({ data }) => !data.draft);

// タイトル順
const pages = [...entries].sort((a, b) => (a.data.title ?? "").localeCompare(b.data.title ?? ""));

// タグ一覧（頻度順）
const tagCount = new Map<string, number>();
for (const p of pages) for (const t of p.data.tags ?? []) tagCount.set(t, (tagCount.get(t) ?? 0) + 1);
const tags = [...tagCount.entries()].sort((a, b) => b[1] - a[1]).map(([t]) => t);

const crumbs = [
  { label: "Homepage", href: `${BASE}/` },
  { label: "phasmophobia" },
];
---

<WikiLayout
  title="Phasmophobia Wiki"
  description="Phasmophobiaに関する知ってると便利な知識をまとめてます"
  crumbs={crumbs}
>
  <div class="controls">
    <label class="search">
      <span class="sr-only">検索</span>
      <input id="q" type="search" placeholder="検索" autocomplete="off" />
    </label>

    <div class="tags" id="tags">
      <button class="tag ghost" type="button" data-tag="">全て</button>
      {tags.map((t) => (
        <button class="tag" type="button" data-tag={t}>#{t} <span class="n">{tagCount.get(t)}</span></button>
      ))}
    </div>
  </div>

  <ul class="grid" id="grid">
    {pages.map((p) => {
      const href = `${BASE}/phasmophobia/${p.id}/`;
      const tagStr = (p.data.tags ?? []).join(" ").toLowerCase();
      return (
<li class="card">
  <a class="cardLink" href={`${BASE}/phasmophobia/${p.id}/`}>
    <div class="title">{p.data.title}</div>

    {p.data.description && (
      <p class="desc">{p.data.description}</p>
    )}

    {(p.data.tags?.length ?? 0) > 0 && (
      <ul class="tags">
        {(p.data.tags ?? []).slice(0, 8).map((t) => (
          <li class="tag">#{t}</li>
        ))}
      </ul>
    )}
  </a>
</li>
      );
    })}
  </ul>

  <div class="empty" id="empty" hidden>
    <div class="emptyTitle">該当ページがありません</div>
    <div class="muted">検索語やタグを変えてください。</div>
  </div>

  <script>
    const q = document.getElementById("q");
    const tags = document.getElementById("tags");
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");

    let activeTag = "";

    function apply() {
      const query = (q.value || "").trim().toLowerCase();
      const nodes = [...grid.querySelectorAll(".card")];

      let shown = 0;
      for (const el of nodes) {
        const title = el.dataset.title || "";
        const id = el.dataset.id || "";
        const t = el.dataset.tags || "";

        const okQuery = !query || title.includes(query) || id.includes(query) || t.includes(query);
        const okTag = !activeTag || t.includes(activeTag);

        const ok = okQuery && okTag;
        el.hidden = !ok;
        if (ok) shown++;
      }
      empty.hidden = shown !== 0;
    }

    q.addEventListener("input", apply);

    tags.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-tag]");
      if (!btn) return;
      activeTag = (btn.dataset.tag || "").toLowerCase();

      for (const b of tags.querySelectorAll("button[data-tag]")) {
        const isActive = (b.dataset.tag || "").toLowerCase() === activeTag && activeTag !== "";
        b.classList.toggle("active", isActive);
      }
      apply();
    });

    apply();
  </script>

  <style>
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .controls{display:grid;gap:12px}
    .search input{
      width:min(560px, 100%);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: var(--panel2);
      outline:none;
    }
    .search input:focus{border-color: rgba(109,40,217,.45); background: #fff}

    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{
      cursor:pointer;
      border:1px solid var(--stroke);
      background: var(--panel2);
      color: rgba(11,18,32,.82);
      padding:7px 10px;
      border-radius:999px;
      font-size:.88rem;
    }
    .tag:hover{border-color: rgba(109,40,217,.35); background: rgba(109,40,217,.06)}
    .tag.active{border-color: rgba(109,40,217,.55); background: rgba(109,40,217,.10)}
    .tag .n{opacity:.65; margin-left:6px}
    .tag.ghost{opacity:.9}
  
.grid{
  list-style:none;
  padding:0;
  margin:18px 0 0;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}

/* Notion-ish card */
.card{
  border:1px solid rgba(15,23,42,.08);
  border-radius:14px;
  background:#fff;
  box-shadow: 0 1px 0 rgba(15,23,42,.03), 0 10px 26px rgba(15,23,42,.06);
  overflow:hidden;
}

.cardLink{
  display:block;
  padding:16px 16px 14px;
  height:100%;
  /* リンクの既定見た目を完全排除 */
  text-decoration:none !important;
  color: inherit !important;
}

/* visitedでも一切変えない */
.cardLink:visited{
  color: inherit !important;
  text-decoration:none !important;
}

/* 子要素にも下線を絶対に出さない */
.cardLink *{
  text-decoration:none !important;
}

/* hoverは控えめ（Notion寄せ） */
.card:hover{
  border-color: rgba(109,40,217,.18);
  box-shadow: 0 1px 0 rgba(15,23,42,.03), 0 16px 40px rgba(15,23,42,.09);
  transform: translateY(-1px);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.cardLink:focus-visible{
  outline: 3px solid rgba(109,40,217,.18);
  outline-offset: 2px;
  border-radius:14px;
}

/* タイトル：タイトルっぽく（大きめ・太め） */
.title{
  font-size: 1.18rem;
  font-weight: 800;
  letter-spacing: .1px;
  line-height: 1.25;
  color: rgba(11,18,32,.94);
}

/* 説明：薄字・小さめ */
.desc{
  margin: 8px 0 0;
  font-size: .92rem;
  line-height: 1.6;
  color: rgba(11,18,32,.58); /* ←薄字 */
}

/* タグ：視線誘導しすぎないが見える */
.tags{
  list-style:none;
  padding:0;
  margin: 12px 0 0;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.tag{
  font-size: .78rem;
  color: rgba(11,18,32,.60);
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.08);
  padding: 3px 8px;
  border-radius: 999px;
}

/* 説明が長いときの揃え（任意） */
.desc{
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow:hidden;
}

/* Responsive */
@media (max-width:980px){
  .grid{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:640px){
  .grid{grid-template-columns:1fr}
}
  </style>
</WikiLayout>
